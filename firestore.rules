rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES CORE ---
    function signedIn() { 
      return request.auth != null; 
    }
    
    function currentUid() { 
      return request.auth.uid; 
    }

    function isMatchOwner(matchData) {
      return matchData.creador == currentUid() || matchData.organizerId == currentUid();
    }

    function isParticipantAfterUpdate() {
      return request.resource.data.jugadores is list &&
             request.resource.data.jugadores.hasAny([currentUid()]);
    }

    // EXCEPCIÃ“N MAESTRA PARA ADMIN (Email directo o Rol en DB)
    function isAdmin() {
      return signedIn() && (
        request.auth.token.email == 'Juanan221091@gmail.com' || 
        (exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'Admin')
      );
    }

    function isApproved() {
      return isAdmin() || (signedIn() && exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) && 
             (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.status == 'approved' ||
              get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.aprobado == true));
    }

    // --- REGLAS POR COLECCIÃ“N ---

    match /usuarios/{uid} {
      allow get: if signedIn();
      allow list: if isApproved();
      allow create: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow update: if isAdmin() || (signedIn() && (
        request.auth.uid == uid ||
        (isApproved() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['puntosRanking', 'lastDiaryImpact']))
      ));
      allow delete: if isAdmin();

      match /devices/{deviceId} {
        allow read, write: if isAdmin() || (signedIn() && request.auth.uid == uid);
      }
    }

    match /partidosAmistosos/{matchId} {
      allow read, list: if isApproved();
      allow create: if isApproved();
      allow update: if isAdmin() || (isApproved() && (
        // 1. Propietario u Organizador
        isMatchOwner(resource.data) ||
        // 2. Participantes reportando resultado
        (resource.data.jugadores.hasAny([currentUid()]) && 
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['resultado', 'estado', 'diaryImpactBy'])) ||
        // 3. Unirse al partido (Si hay hueco y no estaba)
        (!resource.data.jugadores.hasAny([currentUid()]) &&
         request.resource.data.jugadores.hasAny([currentUid()]) &&
         request.resource.data.jugadores.size() == 4) ||
        // 4. Salirse del partido
        (resource.data.jugadores.hasAny([currentUid()]) &&
         !request.resource.data.jugadores.hasAny([currentUid()]) &&
         request.resource.data.jugadores.size() == 4)
      ));
      allow delete: if isAdmin() || (isApproved() && resource.data.creador == currentUid());
      
      match /chat/{msgId} {
        allow read, write: if isApproved();
      }
    }

    match /partidosReto/{matchId} {
      allow read, list: if isApproved();
      allow create: if isApproved();
      allow update: if isAdmin() || (isApproved() && (
        isMatchOwner(resource.data) ||
        // 2. Participantes reportando resultado
        (resource.data.jugadores.hasAny([currentUid()]) && 
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['resultado', 'estado', 'diaryImpactBy'])) ||
        // 3. Unirse al partido
        (!resource.data.jugadores.hasAny([currentUid()]) &&
         request.resource.data.jugadores.hasAny([currentUid()]) &&
         request.resource.data.jugadores.size() == 4) ||
        // 4. Salirse del partido
        (resource.data.jugadores.hasAny([currentUid()]) &&
         !request.resource.data.jugadores.hasAny([currentUid()]) &&
         request.resource.data.jugadores.size() == 4)
      ));
      allow delete: if isAdmin() || (isApproved() && resource.data.creador == currentUid());

      match /chat/{msgId} {
        allow read, write: if isApproved();
      }
    }

    match /rankingLogs/{logId} {
      allow read, list: if isApproved();
      allow create: if isAdmin() || isApproved();
      allow update, delete: if isAdmin();
    }

    match /matchPointDetails/{id} {
      allow read, list: if isApproved();
      allow create: if isAdmin() || isApproved();
      allow update, delete: if isAdmin();
    }

    match /notificaciones/{id} {
      allow read, delete: if signedIn() && (resource.data.destinatario == currentUid() || resource.data.uid == currentUid());
      allow create: if isApproved();
      allow update: if signedIn() && (resource.data.destinatario == currentUid() || resource.data.uid == currentUid());
    }

    match /sugerenciasIA/{id} {
      allow create: if isApproved();
      allow get: if isAdmin() || (signedIn() && resource.data.uid == currentUid());
      allow list: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /palasCatalogo/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /diarioTecnico/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
      allow create: if signedIn() && (isAdmin() || request.resource.data.uid == currentUid());
      allow update, delete: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
    }

    match /diario/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
      allow create: if signedIn() && (isAdmin() || request.resource.data.uid == currentUid());
      allow update, delete: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
    }

    match /palas/{id} {
      allow read: if signedIn();
      allow create: if signedIn() && (isAdmin() || request.resource.data.createdBy == currentUid());
      allow update, delete: if signedIn() && (isAdmin() || resource.data.createdBy == currentUid());
    }

    // REGLA DE SEGURIDAD GLOBAL (BLOQUEO POR DEFECTO PERO PERMISO ADMIN)
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}


