rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES CORE ---
    function signedIn() { 
      return request.auth != null; 
    }
    
    function currentUid() { 
      return request.auth.uid; 
    }

    function isMatchOwner(matchData) {
      return matchData.creador == currentUid() || matchData.organizerId == currentUid();
    }

    function isMatchFinished(data) {
      return (data.estado == 'jugado' || data.estado == 'cancelado' || data.estado == 'anulado') ||
             (data.resultado is map && data.resultado.sets is string);
    }

    function participantInBeforeAndAfter() {
      return resource.data.jugadores is list &&
             request.resource.data.jugadores is list &&
             resource.data.jugadores.hasAny([currentUid()]) &&
             request.resource.data.jugadores.hasAny([currentUid()]);
    }

    function isParticipantResultUpdate() {
      return participantInBeforeAndAfter() &&
             !isMatchFinished(resource.data) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly([
               'resultado',
               'estado',
               'diaryImpactBy',
               'eloSummary',
               'rankingProcessedAt',
               'rankingProcessedResult',
               'rankingProcessedBy'
             ]);
    }

    function isParticipantTeamSwapUpdate() {
      return participantInBeforeAndAfter() &&
             !isMatchFinished(resource.data) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly([
               'jugadores',
               'equipoA',
               'equipoB'
             ]);
    }

    function isSelfJoinOrLeaveUpdate() {
      return resource.data.jugadores is list &&
             request.resource.data.jugadores is list &&
             !isMatchFinished(resource.data) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly([
               'jugadores',
               'equipoA',
               'equipoB',
               'creador',
               'organizerId'
             ]) &&
             (
               (!resource.data.jugadores.hasAny([currentUid()]) &&
                request.resource.data.jugadores.hasAny([currentUid()])) ||
               (resource.data.jugadores.hasAny([currentUid()]) &&
                !request.resource.data.jugadores.hasAny([currentUid()]))
             );
    }

    // EXCEPCIÃ“N MAESTRA PARA ADMIN (Email directo o Rol en DB)
    function isAdmin() {
      return signedIn() && (
        request.auth.token.email == 'Juanan221091@gmail.com' ||
        request.auth.token.email == 'juanan221091@gmail.com' || 
        (exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'Admin')
      );
    }

    function isApproved() {
      return isAdmin() || (signedIn() && exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) && 
             (get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.status == 'approved' ||
              get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.aprobado == true));
    }

    // --- REGLAS POR COLECCIÃ“N ---

    match /usuarios/{uid} {
      allow get: if signedIn();
      allow list: if isApproved();
      allow create: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow update: if isAdmin() || (signedIn() && (
        request.auth.uid == uid ||
        (isApproved() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['puntosRanking', 'lastDiaryImpact']))
      ));
      allow delete: if isAdmin();

      match /devices/{deviceId} {
        allow read, write: if isAdmin() || (signedIn() && request.auth.uid == uid);
      }
    }

    match /partidosAmistosos/{matchId} {
      allow read, list: if isApproved();
      allow create: if isApproved();
      allow update: if isAdmin() || (isApproved() && (
        (isMatchOwner(resource.data) && resource.data.jugadores.hasAny([currentUid()])) ||
        isParticipantResultUpdate() ||
        isParticipantTeamSwapUpdate() ||
        isSelfJoinOrLeaveUpdate()
      ));
      allow delete: if isAdmin() || (isApproved() && resource.data.creador == currentUid());
      
      match /chat/{msgId} {
        allow read, write: if isApproved();
      }
    }

    match /partidosReto/{matchId} {
      allow read, list: if isApproved();
      allow create: if isApproved();
      allow update: if isAdmin() || (isApproved() && (
        (isMatchOwner(resource.data) && resource.data.jugadores.hasAny([currentUid()])) ||
        isParticipantResultUpdate() ||
        isParticipantTeamSwapUpdate() ||
        isSelfJoinOrLeaveUpdate()
      ));
      allow delete: if isAdmin() || (isApproved() && resource.data.creador == currentUid());

      match /chat/{msgId} {
        allow read, write: if isApproved();
      }
    }

    match /rankingLogs/{logId} {
      allow read, list: if isApproved();
      allow create: if isAdmin() || isApproved();
      allow update, delete: if isAdmin();
    }

    match /matchPointDetails/{id} {
      allow read, list: if isApproved();
      allow create: if isAdmin() || isApproved();
      allow update, delete: if isAdmin();
    }

    match /notificaciones/{id} {
      allow read, delete: if signedIn() && (resource.data.destinatario == currentUid() || resource.data.uid == currentUid());
      allow create: if isApproved();
      allow update: if signedIn() && (resource.data.destinatario == currentUid() || resource.data.uid == currentUid());
    }

    match /sugerenciasIA/{id} {
      allow create: if isApproved();
      allow get: if isAdmin() || (signedIn() && resource.data.uid == currentUid());
      allow list: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /palasCatalogo/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /diarioTecnico/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
      allow create: if signedIn() && (isAdmin() || request.resource.data.uid == currentUid());
      allow update, delete: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
    }

    match /diario/{id} {
      allow read: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
      allow create: if signedIn() && (isAdmin() || request.resource.data.uid == currentUid());
      allow update, delete: if signedIn() && (isAdmin() || resource.data.uid == currentUid());
    }

    match /palas/{id} {
      allow read: if signedIn();
      allow create: if signedIn() && (isAdmin() || request.resource.data.createdBy == currentUid());
      allow update, delete: if signedIn() && (isAdmin() || resource.data.createdBy == currentUid());
    }

    // REGLA DE SEGURIDAD GLOBAL (BLOQUEO POR DEFECTO PERO PERMISO ADMIN)
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
